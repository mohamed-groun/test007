{% extends 'base.html.twig' %}
{% trans_default_domain 'generator' %}

{% block body %}

    <!-- Custom styles for this template-->
    <link href="{{ asset('assets/css/generator.css') }}" rel="stylesheet">
<main>
    <div class="container-fluid py-4">
        <div class="row g-4">
            {# Colonne gauche : import d'images #}
            <div class="col-sm-12 col-lg-2">
                <div class="panel*2">
                    <form id="upload-form">
                        <div>
                            <div id="drop-area"
                                 class="border rounded-4 p-2 text-center shadow-sm cursor-pointer position-relative"
                                 onclick="document.getElementById('fileElem').click()">

                                <div class="cloud-icon-container-2">
                                    <i class="bi bi-cloud-arrow-down-fill fs-10"
                                       style="color: #0d6efd; font-size: 4.5rem"></i>
                                </div>

                                <p class="text-title-photo mb-1">
                                    {{ 'generator.upload.drag_drop'|trans }}
                                </p>

                                <p class="text-violet">
                                    {{ 'generator.upload.or'|trans }}
                                </p>

                                <p class="btn btn-light file-button">
                                    {{ 'generator.upload.choose_files'|trans }}
                                </p>

                                <input type="file"
                                       id="fileElem"
                                       multiple
                                       accept="image/png,application/pdf"
                                       style="display:none;">
                            </div>
                        </div>

                        <div id="error-image" style="color: red"></div>
                        <div class="preview col-mobile" id="preview"></div>
                        <input type="hidden" id="id_format_choice" name="format-choice" value="1">
                    </form>
                </div>
            </div>

            {# Colonne centrale : aperçu PDF #}
            <div class="col-sm-12 col-lg-7">
                <div class="panel-2 panel-preview-2">
                    <h5 class="mb-3 text-center">
                        {{ 'generator.page.pdf_preview'|trans }}
                    </h5>

                    <div id="canvasContainer" class="supports-row"></div>
                </div>
            </div>

            {# Colonne droite : configuration #}
            <div class="col-sm-12 col-lg-3">
                <div class="config-card">
                    <h5 class="config-title">
                        {{ 'generator.config.title'|trans }}
                    </h5>

                    <div class="form-group mb-4">
                        <div class="row">
                            <div class="col-sm-11 col-lg-11">
                                <label class="form-label">
                                    {{ 'generator.config.format.label'|trans }}
                                </label>
                                <select class="select2 form-control"
                                        id="support"
                                        name="support[]"
                                        multiple="multiple"
                                        onchange="toggleButtons(false);">
                                    {% for support in supports %}
                                        <option value="{{ support.id }}">
                                            {{ support.name }} — {{ support.description }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-sm-1 col-lg-1 text-center">
                                <!-- Icône avec animation hover et ouverture modal -->
                                <i class="bi bi-question-circle fs-4 animated-icon"
                                   data-bs-toggle="modal"
                                   data-bs-target="#infoModal"
                                   id="helpIcon"
                                   title="Cliquez pour plus d'infos"></i>

                            </div>
                        </div>
                    </div>

                    <div class="form-group d-flex align-items-center justify-content-between mb-3">
                        <label class="form-label mb-0">
                            {{ 'generator.config.spacing.label'|trans }}
                        </label>
                        <input type="number"
                               class="form-control form-control-sm input-small"
                               id="space_between_logos"
                               name="space_between_logos"
                               min="0.2"
                               max="2"
                               value="0.5"
                               onchange="toggleButtons(false);">
                    </div>

                    <div class="form-group d-flex align-items-center justify-content-between mb-3">
                        <label class="form-label mb-0">
                            {{ 'generator.config.margin.label'|trans }}
                        </label>
                        <input type="number"
                               class="form-control form-control-sm input-small"
                               id="margin"
                               name="margin"
                               min="0.2"
                               max="2"
                               value="0.5"
                               onchange="toggleButtons(false);">
                    </div>

                    <div class="form-check form-switch mb-4" style="padding-left: 2.5em">
                        <input class="form-check-input"
                               type="checkbox"
                               id="with_banner"
                               name="with_banner"
                               checked
                               onchange="toggleButtons(false);">
                        <label class="form-check-label" for="band">
                            {{ 'generator.config.banner.label'|trans }}
                        </label>
                    </div>

                    <button id="preview_button"
                            type="button"
                            onclick="submitForm('preview')"
                            class="btn btn-primary w-100 btn-download">
                        {{ 'generator.config.buttons.preview'|trans }}
                    </button>

                    <button id="download_button"
                            type="button"
                            data-id-file=""
                            onclick="submitForm('download')"
                            class="btn btn-primary w-100 btn-download d-none">
                        {{ 'generator.config.buttons.download'|trans }}
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal -->
    <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="infoModalLabel">{{ 'modal.info.title'|trans }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ 'modal.info.close_button'|trans }}"></button>
                </div>
                <div class="modal-body">
                    <p><strong>{{ 'modal.info.description_intro'|trans }}</strong></p><br>
                    <ul>
                        <li>{{ 'modal.info.format1'|trans }}</li>
                        <li>{{ 'modal.info.format2'|trans }}</li>
                        <li>{{ 'modal.info.format3'|trans }}</li>
                        <li>{{ 'modal.info.format4'|trans }}</li>
                        <li>{{ 'modal.info.format5'|trans }}</li>
                    </ul><br>
                    <p>
                        <strong>{{ 'modal.info.description_outro'|trans }}</strong>
                        <a href="{{ path('dashboard_supports') }}" target="_blank">{{ 'modal.info.description_outro2'|trans }}</a>
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ 'modal.info.close_button'|trans }}</button>
                </div>
            </div>
        </div>
    </div>



</main>
    <script>
        const favoriteImages = {{ favorites|json_encode|raw }};
    </script>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        var message_succes1 ="{{ 'message_succes1' |trans }}"
        var message_error1 ="{{ 'message_error1' |trans }}"
        var message2 ="{{'messages.upgrade_premium' |trans }}"
    </script>
    <script src="{{ asset('js/logosSheet.js') }}"></script>
    <script>
        $(document).ready(function () {
            $('#support').select2({
                placeholder: "{{ 'generator.config.format.placeholder'|trans }}",
                allowClear: true
            });
        });
    </script>

    <script>
        function createDefaultRenderPreviewCanvas() {
            const container = document.getElementById("canvasContainer");
            container.innerHTML = '';

            const card = document.createElement('div');
            card.className = 'sheet-card';
            card.innerHTML = `
        <div class="canvas-wrapper" style="width: 100%; max-width: 600px; margin: auto;">
            <canvas></canvas>
        </div>
    `;
            container.appendChild(card);

            const canvas = card.querySelector('canvas');
            const ctx = canvas.getContext('2d');

            // Dimensions "logiques" du support
            const supportWidth = 210;
            const supportHeight = 297;
            const scale = 2;

            // Taille interne du canvas pour le rendu haute résolution
            canvas.width = supportWidth * scale;
            canvas.height = supportHeight * scale;

            // Taille CSS pour le rendu responsive, limité pour desktop
            canvas.style.width = '100%';
            canvas.style.height = 'auto'; // conserve le ratio

            // Bordure et fond
            ctx.strokeStyle = '#111827';
            ctx.lineWidth = 1.5;
            ctx.strokeRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = 'rgba(238,238,238,0.3)';
            ctx.fillRect(
                10 * scale,
                10 * scale,
                canvas.width - 20 * scale,
                canvas.height - 60 * scale
            );

            const bannerHeightPx = 38 * scale;
            ctx.fillStyle = 'rgba(59,130,246,0.6)';
            ctx.fillRect(0, canvas.height - bannerHeightPx, canvas.width, bannerHeightPx);

            ctx.fillStyle = '#ffffff';
            ctx.font = `${12 * scale}px sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(
                "{{ 'generator.canvas.footer_text'|trans }}",
                canvas.width / 2,
                canvas.height - bannerHeightPx / 2
            );
        }



        createDefaultRenderPreviewCanvas();
    </script>
{% endblock %}
